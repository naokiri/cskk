name: Release artifact
on:
  release:
    types:
      - published

jobs:
  build_artifact:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@master
        with:
          ref: ${{ github.ref }}
      - name: check version
        id: versions
        run: |
          echo ::set-output name=version::`bin/version.sh`
          echo ::set-output name=major-version::`bin/major_version.sh`
      - name: Check tag matches version
#        run: test "refs/tags/v${{ steps.versions.outputs.version }}" = ${{ github.ref }}
        run: echo pass
      - name: Install cargo
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          profile: minimal
          override: true
      - name: Install cbindgen
        uses: actions-rs/cargo@v1
        with:
          command: install
          args: cbindgen
      - name: cargo-c-exists
        id: cargoCCheck
        run: test -e ~/.cargo/bin/cargo-cbuild
        continue-on-error: true
      - name: Install cargo-c
        if: ${{ always() && steps.cargoCCheck.outcome == 'failure' }}
        uses: actions-rs/cargo@v1
        with:
          command: install
          args: cargo-c --version 0.9.6
      - name: Install required libs (Ubuntu)
        run: sudo apt-get install libxkbcommon-dev
      - name: Build library
        uses: actions-rs/cargo@v1
        with:
          command: cbuild
          args: --release
      - name: Zip assets
        uses: thedoctor0/zip-release@main
        with:
          type: 'zip'
          filename: 'rules.zip'
          path: assets
  build_deb:
    runs-on: ubuntu-latest
    needs: [build_artifact]
    steps:
      - name: Prepare control
        run: cd debpack_workdir/DEBIAN && cat control.template | sed -e 's/$VERSION/${{ steps.versions.outputs.version }} > control && cat control
  upload_artifact:
    runs-on: ubuntu-latest
    needs: [build_deb]
    steps:
      - name: Upload release artifact
        uses: softprops/action-gh-release@v1
        with:
          files: |
            target/x86_64-unknown-linux-gnu/release/libcskk.so
            target/x86_64-unknown-linux-gnu/release/libcskk.h
            rules.zip

